name: Build RockChip U-Boot

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /usr/local/share/boost || true
        sudo rm -rf /opt/hostedtoolcache || true
        df -h
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          gcc-arm-none-eabi \
          bison \
          flex \
          python3 \
          python-is-python3 \
          device-tree-compiler \
          bc \
          make \
          git

    - name: Clone rkbin repository
      run: |
        git clone --depth 1 https://github.com/rockchip-linux/rkbin.git

    - name: Clone RockChip u-boot
      run: |
        git clone --depth 1 --branch stable-4.4-rk3399-linux https://github.com/rockchip-linux/u-boot.git

    - name: Prepare u-boot build
      run: |
        cd u-boot
        
        # Modify make.sh to use system toolchains instead of project-specified ones
        sed -i 's@TOOLCHAIN_ARM32=.*@TOOLCHAIN_ARM32=/@g' ./make.sh
        sed -i 's@TOOLCHAIN_ARM64=.*@TOOLCHAIN_ARM64=/@g' ./make.sh
        sed -i 's@${absolute_path}/bin/@@g' ./make.sh

    - name: Build u-boot
      run: |
        cd u-boot
        
        # Build u-boot for evb-rk3399
        ./make.sh evb-rk3399
        
        # Show built files
        echo "Built files:"
        ls -lh *.img *.bin 2>/dev/null || true

    - name: Generate idbloader.img
      run: |
        cd u-boot
        
        # Find the latest DDR and miniloader binaries
        DDR_BIN=$(ls -1 ../rkbin/bin/rk33/rk3399_ddr_800MHz_v*.bin 2>/dev/null | sort -V | tail -1)
        MINILOADER_BIN=$(ls -1 ../rkbin/bin/rk33/rk3399_miniloader_v*.bin 2>/dev/null | sort -V | tail -1)
        
        # Validate binaries exist
        if [ -z "$DDR_BIN" ] || [ ! -f "$DDR_BIN" ]; then
          echo "Error: DDR binary not found in rkbin repository"
          exit 1
        fi
        if [ -z "$MINILOADER_BIN" ] || [ ! -f "$MINILOADER_BIN" ]; then
          echo "Error: Miniloader binary not found in rkbin repository"
          exit 1
        fi
        
        echo "Using DDR binary: $DDR_BIN"
        echo "Using miniloader binary: $MINILOADER_BIN"
        
        # Generate idbloader.img using rkbin tools
        ../rkbin/tools/mkimage -n rk3399 -T rksd -d "$DDR_BIN" idbloader.img
        cat "$MINILOADER_BIN" >> idbloader.img
        
        echo "idbloader.img generated:"
        ls -lh idbloader.img

    - name: Prepare artifacts
      run: |
        mkdir -p output
        
        # Validate required files exist
        for file in idbloader.img uboot.img trust.img; do
          if [ ! -f "u-boot/$file" ]; then
            echo "Error: Required file u-boot/$file not found"
            exit 1
          fi
        done
        
        # Copy the required files
        cp u-boot/idbloader.img output/
        cp u-boot/uboot.img output/
        cp u-boot/trust.img output/
        
        # Also copy the loader if generated (using shopt for safe globbing)
        shopt -s nullglob
        loader_files=(u-boot/rk3399_loader_*.bin)
        shopt -u nullglob
        if [ ${#loader_files[@]} -gt 0 ]; then
          cp "${loader_files[@]}" output/
        fi
        
        # Show artifact sizes
        echo "Artifact sizes:"
        ls -lh output/

    - name: Get build info
      id: build_info
      run: |
        # Validate Makefile exists
        if [ ! -f "u-boot/Makefile" ]; then
          echo "Error: u-boot/Makefile not found"
          exit 1
        fi
        
        # Get u-boot version from Makefile
        VERSION=$(grep -E '^VERSION\s*=' u-boot/Makefile | head -1 | cut -d= -f2 | tr -d ' ')
        PATCHLEVEL=$(grep -E '^PATCHLEVEL\s*=' u-boot/Makefile | head -1 | cut -d= -f2 | tr -d ' ')
        SUBLEVEL=$(grep -E '^SUBLEVEL\s*=' u-boot/Makefile | head -1 | cut -d= -f2 | tr -d ' ')
        EXTRAVERSION=$(grep -E '^EXTRAVERSION\s*=' u-boot/Makefile | head -1 | cut -d= -f2 | tr -d ' ')
        
        # Validate VERSION and PATCHLEVEL are set
        if [ -z "$VERSION" ] || [ -z "$PATCHLEVEL" ]; then
          echo "Error: Could not extract version from Makefile"
          exit 1
        fi
        
        FULL_VERSION="${VERSION}.${PATCHLEVEL}"
        if [ -n "$SUBLEVEL" ] && [ "$SUBLEVEL" != "0" ]; then
          FULL_VERSION="${FULL_VERSION}.${SUBLEVEL}"
        fi
        if [ -n "$EXTRAVERSION" ]; then
          FULL_VERSION="${FULL_VERSION}${EXTRAVERSION}"
        fi
        
        # Get build date
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        echo "version=${FULL_VERSION}" >> "$GITHUB_OUTPUT"
        echo "build_date=${BUILD_DATE}" >> "$GITHUB_OUTPUT"
        echo "U-Boot version: ${FULL_VERSION}"
        echo "Build date: ${BUILD_DATE}"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: rockchip-uboot-${{ steps.build_info.outputs.version }}-${{ github.run_number }}
        name: RockChip U-Boot ${{ steps.build_info.outputs.version }}
        body: |
          ## RockChip U-Boot Build
          
          - **U-Boot Version**: ${{ steps.build_info.outputs.version }}
          - **Branch**: stable-4.4-rk3399-linux
          - **Build Date**: ${{ steps.build_info.outputs.build_date }}
          - **Commit**: ${{ github.sha }}
          
          ### Files
          - `idbloader.img`: TPL + SPL combined image (DDR initialization + loader)
          - `uboot.img`: U-Boot image
          - `trust.img`: Trusted firmware (ATF) image
          
          ### Usage
          These files can be used with the build_image.sh script to create a complete system image.
          
          Flash to eMMC or SD card according to the RockChip partition layout:
          - idbloader.img -> sector 64
          - uboot.img -> sector 16384
          - trust.img -> sector 24576
        files: |
          output/idbloader.img
          output/uboot.img
          output/trust.img
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
